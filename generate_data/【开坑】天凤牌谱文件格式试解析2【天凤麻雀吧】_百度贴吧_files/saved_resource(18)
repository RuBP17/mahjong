_.Module.define({path:"props/widget/MagicProps",requires:["props/widget/Residual"],sub:{initial:function(t){this.$wrap=t.wrap,this.dataObj=t.propsData,this.visible=!1,this.initOptions(),this.loadComponent(),this.buildProps()},initOptions:function(){this.propsOptions={1070001:{key:"worship",name:"\u9B54\u62DC",flashOptions:{width:320,height:390,marginLeft:0,marginTop:0}},1070002:{key:"egg",name:"\u9B54\u86CB",flashOptions:{width:900,height:600,marginLeft:384,marginTop:70}}},this.mallurl="/tbmall/propslist?category=107",this.poolSize=5;var t=window.navigator.userAgent.match(/chrome/i);this.page=t?$(document.body):$(document.documentElement)},loadComponent:function(){this.residual=this.use("props/widget/Residual")},buildProps:function(){this.initPropsData(),this.propsList.length>0&&(this.visible=!0,this.initPropsUI(),this.bindPropsEvents())},initPropsData:function(){for(var t=this.dataObj.owner||{},a=null,i=null,s=[],e={},o=["1070001","1070002"],r=0;r<o.length;r++)i=o[r],a={id:i,count:t[i]&&t[i].left_num||0},$.extend(a,this.propsOptions[i]),s.push(a),e[i]=a;this.propsList=s,this.propsMap=e},initPropsUI:function(){for(var t=this,a=$('<ul class="tbui_aside_props_list clearfix" id="tbui_aside_props_list"></ul>'),i=new Array,s=null,e=0;e<t.propsList.length;e++)s=t.propsList[e],i.push('<li class="props_item props_item_'+s.id+'">'),s.count>0?i.push('<a class="j_props_btn props_item_btn" href="#" data-id="'+s.id+'"><img src="//tb2.bdstatic.com/tb/static-props/img/props/'+s.key+'.png"/></a>'):i.push('<a class="props_item_btn" target="_blank" href="'+t.mallurl+'" data-id="'+s.id+'"><img src="//tb2.bdstatic.com/tb/static-props/img/props/'+s.key+'.png"/><span class="props_buy_icon"></span></a>'),i.push('<p class="props_item_title">'),i.push("<span>"+s.name+"</span>"),s.count>0&&(i.push('<span class="props_item_sign">'+String.fromCharCode(215)+"</span>"),i.push('<span class="props_item_num">'+s.count+"</span>")),i.push("</p>"),i.push("</li>");a.html(i.join("")),a.hide().appendTo(t.$wrap),t.$propsList=a},bindPropsEvents:function(){var t=this;t.$wrap.delayhover({enterDelay:300,leaveDelay:700,mouseenter:function(){t.$propsList.fadeIn()},mouseleave:function(){t.$propsList.fadeOut()}}).children("a").click(function(t){t.preventDefault(),t.stopPropagation()}),t.$propsList.delegate(".j_props_btn","click",function(){var a=$(this).data("id"),i=t.propsMap[a];return t.propsObj=i,i.count>0&&("pb"==PageData.product?t.buildPostArea():"ihome"==PageData.product&&t.buildIhomeArea(),t.buildMask(),t.initFlashCallbacks()),!1})},buildIhomeArea:function(){var t={jdom:$("div.userinfo_wrap"),userId:this.dataObj.home_user_id,propsData:this.dataObj.home_user_props,propsType:0},a=$("#headinfo_wrap"),i=a.offset().left,s=a.offset().top,e=i+a.width(),o={marginLeft:i,marginRight:e,marginTop:s,marginBottom:$("body").height()-28};$.extend(t,o),this.limitArea=o,this.areaList=[t]},buildPostArea:function(){for(var t=$("#j_p_postlist"),a=t.find(".j_l_post"),i=null,s=null,e=[],o=t.offset().left,r=t.offset().top,p=o+t.width(),n=0;n<a.length;n++)i=$(a[n]),s=i.getData(),this.doPostItem(i,s,o,p,e);var l={marginLeft:o,marginRight:p,marginTop:r,marginBottom:r+t.height()};this.limitArea=l,this.areaList=e},doPostItem:function(t,a,i,s,e){var o=null,r=null,p=null,n=t.offset().top,l=n+t.height(),h={userId:a.author.user_id,postId:a.content.post_id,propsData:a.content.props,marginTop:n,marginBottom:l};r={},o=t.find(".d_author"),r.jdom=o,r.marginRight=i+130,r.marginLeft=i,$.extend(r,h),e.push(r),p={},o=t.find(".d_post_content_main"),p.jdom=o,p.marginRight=s,p.marginLeft=i+130,$.extend(p,h),e.push(p)},buildMask:function(){this.flashPool=[],this.currScrollTop=0,this.currAreaObj=null,this.initMask(),this.setMaskPosition(0,0,0,0),this.bindMaskEvents()},initMask:function(){var t=$('<div class="mask_layer mask_top"></div>'),a=$('<div class="mask_layer mask_right"></div>'),i=$('<div class="mask_layer mask_bottom"></div>'),s=$('<div class="mask_layer mask_left"></div>'),e=$('<div class="mask_layer light_area"></div>'),o=$('<div id="mask_wrap" class="mask_wrap mouse_'+this.propsObj.key+'"></div>');o.append(t).append(a).append(i).append(s).append(e).css({"z-index":$.getzIndex()}),$("body").append(o),this.$maskWrap=o,this.maskMap={topMask:t,rightMask:a,bottomMask:i,leftMask:s,lightArea:e}},setMaskPosition:function(t,a,i,s){var e=this.maskMap;e.topMask.css({height:a}),e.rightMask.css({left:t+i,top:a,width:$("body").width()-(t+i),height:s}),e.bottomMask.css({top:a+s,height:$("body").height()-(a+s)}),e.leftMask.css({top:a,width:t,height:s}),e.lightArea.css({left:t,top:a,width:i,height:s})},bindMaskEvents:function(){var t=this;$("body").bind("contextmenu",function(){return!1}),$(document).bind("keydown",function(a){if(27==a.which&&null!=t.$maskWrap){if(t.disabledMove)return!1;t.clear()}}),t.$maskWrap.mousedown(function(a){if(3==a.which){if(t.disabledMove)return!1;t.clear()}return!1});var a=50,i=$("body").width()-a,s=0;t.$maskWrap.mousemove(function(a){if(t.$bulletLayer||(t.$bulletLayer=t.buildBulletLayer(),t.$maskWrap.append(t.$bulletLayer)),s=a.pageX,s>i&&(s=i),t.$bulletLayer.css({left:s,top:a.pageY}),t.disabledMove)return!1;var e=null,o=t.limitArea;if(t.isInArea=a.pageX>=o.marginLeft&&a.pageX<=o.marginRight&&a.pageY>=o.marginTop&&a.pageY<=o.marginBottom?!0:!1,t.isInArea)for(var r=0;r<t.areaList.length;r++)e=t.areaList[r],a.pageX>=e.marginLeft&&a.pageX<=e.marginRight&&a.pageY>=e.marginTop&&a.pageY<=e.marginBottom&&(t.setMaskPosition(e.marginLeft,e.marginTop,e.marginRight-e.marginLeft,e.marginBottom-e.marginTop),e.propsType=r%2,t.areaObj=e);else t.setMaskPosition(0,0,0,0)})},buildBulletLayer:function(){var t=this,a=$('<div class="bullet_layer"><span class="bullet_layer_tip">\u53F3\u952E\u53D6\u6D88</span></div>');return a.click(function(){t.isInArea?t.propsObj.count>0?t.flashPool.length<=t.poolSize&&(t.updatePosition(),t.post()):t.showTomallDialog():t.clear()}),a},clear:function(){this.clearPool(),this.$maskWrap.remove(),this.$maskWrap=null,this.$bulletLayer=null,setTimeout(function(){$("body").unbind("contextmenu")},300)},post:function(){var t=this,a="/tbmall/post/useAppraiseProps",i={props_id:t.propsObj.id,target_user_id:t.areaObj.userId||"",type:t.areaObj.propsType,post_id:t.areaObj.postId||"",tbs:PageData.tbs};$.tb.post(a,i,function(a){a&&0==a.no&&t.updatePage()})},updatePage:function(){var t=this.propsObj.id,a=".props_item_"+t;this.updatePropsBtnNum(t,a),("ihome"==PageData.product||"1"==this.areaObj.propsType)&&this.updatePostAreaNum(t,a)},updatePropsBtnNum:function(t,a){var i=$("#tbui_aside_props_list "+a),s=this.propsObj.count-1;s=s>0?s:0,this.propsObj.count=s,s>0?i.find(".props_item_num").text(s):(i.find(".props_item_btn").removeClass("j_props_btn").tbattr("target","_blank").tbattr("href",this.mallurl).append('<span class="props_buy_icon"></span>'),i.find(".props_item_sign").remove(),i.find(".props_item_num").remove())},updatePostAreaNum:function(t,a){var i=this.areaObj.propsData||{};i[t]||(this.areaObj.propsData={},this.areaObj.propsData[t]={num:0});var s=this.areaObj.propsData[t].num+1;s=s>0?s:0,this.areaObj.propsData[t].num=s;var e=this.areaObj.jdom.find("ul.props_appraise_wrap"),o=e.find(a);o[0]?o.find(".props_item_num").text(s):(htmlArr=[],htmlArr.push('<li class="props_item props_item_split"><span class="userinfo_split"></span></li>'),htmlArr.push('<li class="props_item props_item_'+t+'">'),htmlArr.push('<a href="#" data-postid="'+(this.areaObj.postId||"")+'" data-id="'+t+'" class="props_item_icon"></a>'),htmlArr.push('<span class="props_item_plus">'+String.fromCharCode(215)+"</span>"),htmlArr.push('<span class="props_item_num">'+s+"</span></li>"),"1070001"==t?e.prepend($(htmlArr.join(""))):"1070002"==t&&e.append($(htmlArr.join(""))))},updatePosition:function(){var t=this,a=this.propsOptions[this.propsObj.id].flashOptions,i=($(window).height()-a.height)/2;i=150>i?150:i;var s=this.areaObj.jdom.offset().top-i;this.disabledMove=!0;var e=$(window).scrollTop();0==e||e!=this.currScrollTop||this.currAreaObj&&this.currAreaObj.marginTop!=this.areaObj.marginTop?(this.currAreaObj=this.areaObj,this.currScrollTop=e,t.page.animate({scrollTop:s},300,"swing",function(){t.buildFlash(s)})):t.buildFlash(s)},buildFlash:function(t){var a=this,i=0,s=0,e=$('<div class="props_flash_wrap"></div>'),o=this.propsOptions[this.propsObj.id].flashOptions,r=($(window).width()-o.width)/2,p=t+o.marginTop;r=r>0?r:0,p=p>0?p:0,"0"==a.areaObj.propsType&&"1070002"==a.propsObj.id&&("ihome"==PageData.product?(i=100,s=-15):(i=60,s=-20),r=r-(r+o.marginLeft-a.areaObj.jdom.offset().left)+i,p+=s),e.css({width:o.width,height:o.height,left:r,top:p,"z-index":$.getzIndex()});{var n="/tb/static-props/swf/"+this.propsObj.key+".swf?t=140107";new $.swf(n,{container:e,width:o.width,height:o.height,params:{wmode:"transparent"}})}a.flashPool.push(e),a.$maskWrap.append(e),a.topzIndex=$.getzIndex(),a.$bulletLayer.css({"z-index":a.topzIndex})},buildPlusOne:function(){var t=this,a="plusone_"+this.propsObj.key;$.browser.msie&&6==$.browser.version&&(a+="_png8"),a="/tb/static-props/img/"+a+".png";var i=$('<div class="props_plusone"><img src="'+a+'"/></div>'),s=0,e=0;"ihome"==PageData.product?(s=t.areaObj.marginLeft+70,e=t.areaObj.marginTop+300):(s=t.areaObj.marginLeft+(t.areaObj.marginRight-t.areaObj.marginLeft)/2-18,e=t.areaObj.marginTop+100),i.css({left:s,top:e,"z-index":t.topzIndex+1}),t.$maskWrap.append(i),i.animate({top:"-=100px",opacity:.8},800,"swing",function(){i.remove()})},clearPool:function(){for(var t=this,a=t.flashPool,i=null,s=0;s<a.length;s++)i=a.shift(),i.remove();t.disabledMove=!1},initFlashCallbacks:function(){var t=this,a={},i=null;a.finishPlay=function(){if(t.flashPool.length>0){t.buildPlusOne();var a=t.flashPool.shift();a.remove(),t.flashPool.length<=0&&(t.disabledMove=!1,"0"==t.areaObj.propsType&&("ihome"==PageData.product?i=t.areaObj.jdom.find(".userinfo_left"):"pb"==PageData.product&&(i=t.areaObj.jdom.find(".icon_relative")),t.residual.showUI({wrap:i,key:t.propsObj.key})))}},window.MagicProps=a},showTomallDialog:function(){var t=this,a=new $.dialog({title:"\u63D0\u793A",html:'<div class="props_buy_dialog"><p class="buy_dialog_content">\u4F60\u76EE\u524D\u6CA1\u6709\u53EF\u7528\u7684\u9053\u5177\u4E86\uFF0C\u5FEB\u53BB\u5546\u57CE\u8D2D\u4E70\u5427</p><a class="buy_dialog_link" target="_blank" href="'+t.mallurl+'">\u53BB\u8D2D\u4E70>></a><div>',width:400,height:80});a.element.find(".buy_dialog_link").on("click",function(){t.clear(),setTimeout(function(){t.showBuyDialog(t.mallurl)},200)})},showBuyDialog:function(t){var a='<p class="buy_txt">\u9053\u5177\u8D2D\u4E70\u6210\u529F\u540E\u5373\u53EF\u4F7F\u7528\uFF01</p><div class="buy_dialog_btns"><a href="#" class="ui_btn ui_btn_m btn_success"><span><em>\u8D2D\u4E70\u6210\u529F</em></span></a><a href="#{href}" target="_blank"  class="ui_btn ui_btn_sub_m btn_failure"><span><em>\u8D2D\u4E70\u5931\u8D25\uFF0C\u91CD\u65B0\u8D2D\u4E70</em></span></a></div>',i=new $.dialog({title:"\u63D0\u793A",html:$.tb.format(a,{href:$.tb.unescapeHTML(t)}),width:400,height:80});i.bind("onclose",function(){$.tb.location.reload()}),i.element.find(".btn_success").on("click",function(t){t.preventDefault(),$.tb.location.reload()})}}});